// ==UserScript==
// @name         Activity Tracker
// @namespace    com.conwayjw97.activitytracker
// @version      0.1
// @description  Track time spent on websites
// @author       James Conway
// @match        *://*/*
// @match        *//*/*
// @grant        GM_log
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

function minuteDifference(startDate, endDate){
    let diff = secondDifference(startDate, endDate);
    diff /= 60;
    return Math.abs(Math.round(diff));
}

function secondDifference(startDate, endDate){
    let diff = (endDate.getTime() - startDate.getTime()) / 1000;
    return Math.abs(Math.round(diff));
}

function secondToMinute(seconds){
    return Math.floor(seconds * 0.0166667);
}

function todaysTrackingDataPrettyPrint(todaysTrackingData, headline="Today's Activity Tracking Report"){
    GM_log("================================\n");
    GM_log(headline + "\n");
    GM_log("--------------------------------\n");

    let sortedBaseUrls = Object.keys(todaysTrackingData).sort(function(a,b){return todaysTrackingData[b]-todaysTrackingData[a]});

    for (let baseUrl of sortedBaseUrls){
        GM_log(baseUrl + ": " + secondToMinute(todaysTrackingData[baseUrl]) + "min " + (todaysTrackingData[baseUrl] - (secondToMinute(todaysTrackingData[baseUrl]) * 60)) + "sec\n");
    }

    GM_log("================================\n");
}

let url = window.location;
let baseUrl = url.protocol + "//" + url.host + "/";

let accessDate = new Date();
let todaysDate = accessDate.getDate() + "/" + (accessDate.getMonth()+1) + "/" + accessDate.getFullYear(); // Javascript months start from 0 so 1 added

window.onbeforeunload = async function (e) {
    let leaveDate = new Date();
    let secondsSpent = secondDifference(accessDate, leaveDate);

    let todaysTrackingData = JSON.parse(await GM_getValue(todaysDate, "{}"));

    let totalSecondsSpent = secondsSpent;
    if(todaysTrackingData.hasOwnProperty(baseUrl)){
        totalSecondsSpent = todaysTrackingData[baseUrl] + secondsSpent;
    }
    todaysTrackingData[baseUrl] = totalSecondsSpent;

    GM_setValue(todaysDate, JSON.stringify(todaysTrackingData));
};

window.onload = async function (e) {
    let todaysTrackingData = JSON.parse(await GM_getValue(todaysDate, "{}"));
    todaysTrackingDataPrettyPrint(todaysTrackingData, "Today's Activity Tracking Report: " + todaysDate);
};
